<!DOCTYPE html>  <html> <head>   <title>pastebot.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               pastebot.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h3>Initialization</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Require the Express.js library and create the server object. This object,
which we'll name <code>app</code>, is used in pretty much every statement that follows.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">express = </span><span class="nx">require</span> <span class="s1">&#39;express&#39;</span>
<span class="nv">app = </span><span class="nx">express</span><span class="p">.</span><span class="nx">createServer</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Require the Redis library and connect to the server. The connection
information is provided to this script via environment variables. (In NodeJS,
environment variables are available in the hash <code>process.env</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">redis = </span><span class="nx">require</span> <span class="s1">&#39;redis&#39;</span>
<span class="nv">redis_client = </span><span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PASTEBOT_REDIS_PORT</span><span class="p">,</span>
  <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PASTEBOT_REDIS_HOST</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PASTEBOT_REDIS_PASSWORD</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Set up a callback for catching Redis errors.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">redis_client</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>We're going to store these pastes as base-64 strings to avoid lots of
problems. I found a little bit of code for this that will work perfectly,
and translated it to CoffeeScript.
See <code>lib/base64.coffee</code> for some notes on Node's "exporting" of objects.
http://farhadi.ir/works/base64</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">base64 = </span><span class="nx">require</span> <span class="s1">&#39;./lib/base64&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>Configuration</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Enable the bodyParser middleware, so Express knows what to do with the request
body on POST requests. This allows us to use <code>req.body</code> to access POST data.
http://expressjs.com/guide.html#HTTP-Methods</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Set the default view engine for this application to Jade. This allows us
to omit the extension name when calling render() further on.
http://expressjs.com/guide.html#View-Rendering</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;view engine&#39;</span><span class="p">,</span> <span class="s1">&#39;jade&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>Routing</h3>

<p>Express's routing system is very similar to other common web frameworks (ex.
Sinatra). The basic method structure to set up a route is as follows:</p>

<pre><code>app.method path, callback_function
</code></pre>

<p>where <code>method</code> is the HTTP method of the request, and <code>callback_function</code> is
a function which accepts two parameters: a <code>req</code> (request) parameter, which
contains the headers, data, body, etc. of the request, and a <code>res</code> (response)
object, which is used to send responses to the client.</p>

<p>In this application, we'll be using the <code>req</code> variable for its <code>params</code> and
<code>body</code> attributes. <code>params</code> contains any URL parameters (see the last route)
and <code>body</code>, thanks to our bodyParser() setup in Configuration, contains
POST data sent in requests.</p>

<p>We will use two methods of the <code>res</code> object:
  * <code>redirect(path, http_code)</code>
  * <code>render(view_name, options)</code>: Renders a view (stored in the <code>views</code>
    directory of this application.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Let's set up a basic redirect. I'll code a homepage example when I feel less
lazy.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Respond with a 301 Redirect to /pastes/create.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span> <span class="s1">&#39;/pastes/create&#39;</span><span class="p">,</span> <span class="mi">301</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If this is a GET request, the user hasn't input anything yet. Let's render
the form, then.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/pastes/create&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span> <span class="s1">&#39;pastes/create&#39;</span><span class="p">,</span>
    <span class="nv">locals:</span>
      <span class="nv">title: </span><span class="s1">&#39;create paste&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>This is a POST request, so that means the user has submitted the form. (We
know this because we set the paste form's method to POST.) Time to save the
paste to our Redis instance.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span> <span class="s1">&#39;/pastes/create&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Let's build a little JSON container for this paste object, using data
provided in the POST parameters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">paste =</span>
    <span class="nv">language: </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">language</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Encode the paste content as a base-64 string.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">content: </span><span class="nx">base64</span><span class="p">.</span><span class="nx">encode</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">content</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">paste</span>
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Get the next available ID for a paste. Emulating a SQL auto_increment
feature, sorta. This Redis library accepts a callback function, which
will be called once the requested command is completed. It provides an
<code>err</code> object and the result of the command (in the case of a Redis command
like INCR, the new value, post-increment) is set as the second parameter.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">redis_client</span><span class="p">.</span><span class="nx">incr</span> <span class="s1">&#39;pastes:next_id&#39;</span><span class="p">,</span> <span class="nf">(err, id) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Okay, we got an ID. Store that paste object as a JSON string.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">redis_client</span><span class="p">.</span><span class="nx">set</span> <span class="s2">&quot;pastes:id:#{id}&quot;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">paste</span><span class="p">),</span> <span class="nf">(err, json) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Woot, it's set. Let's show it to them - we can just pass that <code>paste</code>
variable we made earlier to the <code>pastes/show</code> view.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span> <span class="s2">&quot;/pastes/#{id}&quot;</span><span class="p">,</span> <span class="mi">301</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>This is a route with a parameter. If none of the above routes are matched
to the request, Express will know that this is the only available route left.
This works just like the routing of a lot of modern web frameworks: Rails,
Sinatra, etc.
So, this will match any URL, pretty much.. except for the requests that come
before it. Express will set the variable <code>req.params.id</code> so we can access
this dynamic value.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;/pastes/:id&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>The <code>id</code> parameter of the route corresponds to a paste ID. Let's fetch the
stored paste.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">redis_client</span><span class="p">.</span><span class="nx">get</span> <span class="s2">&quot;pastes:id:#{req.params.id}&quot;</span><span class="p">,</span> <span class="nf">(err, paste_json) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>We have the paste JSON that was stored earlier. Parse that sucker!
Remember that we stored the <code>content</code> attribute of the paste object as a
base-64 string, so we'll have to decode that after parsing.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">paste = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">paste_json</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
    <span class="nv">paste.content = </span><span class="nx">base64</span><span class="p">.</span><span class="nx">decode</span> <span class="nx">paste</span><span class="p">.</span><span class="nx">content</span>
    </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Render <code>/views/pastes/show.jade</code>, displaying the paste we loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">res</span><span class="p">.</span><span class="nx">render</span> <span class="s1">&#39;pastes/show&#39;</span><span class="p">,</span>
      <span class="nv">locals:</span>
        <span class="nv">title: </span><span class="s1">&#39;view paste&#39;</span>
        <span class="nv">paste: </span><span class="nx">paste</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Tell Express to listen for requests on port 3000.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span> <span class="mi">3000</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 